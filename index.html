<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USD / TWD / JPY 即時換算</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif; margin: 24px; line-height: 1.4; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 680px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    label { display: block; font-size: 12px; color: #555; margin-bottom: 8px; }
    input { width: 100%; font-size: 18px; padding: 10px 12px; border: 1px solid #ccc; border-radius: 10px; outline: none; }
    input:focus { border-color: #888; }
    .meta { margin-top: 14px; color: #555; font-size: 13px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fafafa; cursor: pointer; }
    button:hover { background: #f3f3f3; }
    .badge { display:inline-block; padding: 3px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; color:#444; }
    .err { color: #b00020; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>USD / TWD / JPY 即時換算</h1>

    <div class="grid">
      <div class="card">
        <label for="usd">美金（USD）</label>
        <input id="usd" inputmode="decimal" placeholder="例如 100" />
      </div>

      <div class="card">
        <label for="twd">台幣（TWD）</label>
        <input id="twd" inputmode="decimal" placeholder="例如 3000" />
      </div>

      <div class="card">
        <label for="jpy">日幣（JPY）</label>
        <input id="jpy" inputmode="decimal" placeholder="例如 15000" />
      </div>
    </div>

    <div class="meta">
      <div class="row">
        <span class="badge" id="status">匯率載入中…</span>
        <button id="refresh" type="button">重新抓匯率</button>
        <button id="clear" type="button">清空</button>
      </div>
      <div style="margin-top:8px;">
        <div>使用匯率來源：ExchangeRate-API（Open Access）</div>
        <div id="rateLine">—</div>
        <div id="timeLine">—</div>
      </div>
    </div>
  </div>

  <script>
    // ====== 匯率：以「1 USD = ? TWD / ? JPY」保存 ======
    let USD_TO_TWD = null;
    let USD_TO_JPY = null;
    let lastUpdatedText = "";

    const usdEl = document.getElementById("usd");
    const twdEl = document.getElementById("twd");
    const jpyEl = document.getElementById("jpy");
    const statusEl = document.getElementById("status");
    const rateLineEl = document.getElementById("rateLine");
    const timeLineEl = document.getElementById("timeLine");
    const refreshBtn = document.getElementById("refresh");
    const clearBtn = document.getElementById("clear");

    // 避免互相觸發造成無限迴圈
    let isProgrammaticUpdate = false;

    function setStatus(text, isError=false) {
      statusEl.textContent = text;
      statusEl.classList.toggle("err", isError);
    }

    function fmt(n) {
      if (!isFinite(n)) return "";
      // 保留到小數點後 2 位（可自行調整）
      return (Math.round(n * 100) / 100).toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function parseNumber(s) {
      if (s == null) return NaN;
      // 允許輸入含千分位逗號
      const cleaned = String(s).replace(/,/g, "").trim();
      if (cleaned === "") return NaN;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : NaN;
    }

    function updateFromUSD(usd) {
      if (USD_TO_TWD == null || USD_TO_JPY == null) return;
      isProgrammaticUpdate = true;
      twdEl.value = fmt(usd * USD_TO_TWD);
      jpyEl.value = fmt(usd * USD_TO_JPY);
      isProgrammaticUpdate = false;
    }

    function updateFromTWD(twd) {
      if (USD_TO_TWD == null || USD_TO_JPY == null) return;
      const usd = twd / USD_TO_TWD;
      isProgrammaticUpdate = true;
      usdEl.value = fmt(usd);
      jpyEl.value = fmt(usd * USD_TO_JPY);
      isProgrammaticUpdate = false;
    }

    function updateFromJPY(jpy) {
      if (USD_TO_TWD == null || USD_TO_JPY == null) return;
      const usd = jpy / USD_TO_JPY;
      isProgrammaticUpdate = true;
      usdEl.value = fmt(usd);
      twdEl.value = fmt(usd * USD_TO_TWD);
      isProgrammaticUpdate = false;
    }

    function wireInputs() {
      usdEl.addEventListener("input", () => {
        if (isProgrammaticUpdate) return;
        const usd = parseNumber(usdEl.value);
        if (!Number.isFinite(usd)) { twdEl.value = ""; jpyEl.value = ""; return; }
        updateFromUSD(usd);
      });

      twdEl.addEventListener("input", () => {
        if (isProgrammaticUpdate) return;
        const twd = parseNumber(twdEl.value);
        if (!Number.isFinite(twd)) { usdEl.value = ""; jpyEl.value = ""; return; }
        updateFromTWD(twd);
      });

      jpyEl.addEventListener("input", () => {
        if (isProgrammaticUpdate) return;
        const jpy = parseNumber(jpyEl.value);
        if (!Number.isFinite(jpy)) { usdEl.value = ""; twdEl.value = ""; return; }
        updateFromJPY(jpy);
      });
    }

    async function fetchRates() {
      // ExchangeRate-API Open Access 端點（不需要 key 的版本）
      // 文件/說明：exchangerate-api.com/docs/free  (Open Access) 
      const url = "https://open.er-api.com/v6/latest/USD";

      setStatus("匯率載入中…");
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if (!data || data.result !== "success" || !data.rates) {
          throw new Error("API 回傳格式不符合預期");
        }

        const twd = data.rates.TWD;
        const jpy = data.rates.JPY;

        if (!Number.isFinite(twd) || !Number.isFinite(jpy)) {
          throw new Error("缺少 TWD 或 JPY 匯率");
        }

        USD_TO_TWD = twd;
        USD_TO_JPY = jpy;
        lastUpdatedText = data.time_last_update_utc || "";

        rateLineEl.textContent = `目前匯率：1 USD = ${USD_TO_TWD.toFixed(4)} TWD；1 USD = ${USD_TO_JPY.toFixed(4)} JPY`;
        timeLineEl.textContent = lastUpdatedText ? `API 更新時間：${lastUpdatedText}` : "API 更新時間：—";
        setStatus("匯率已更新 ✅");

        // 若使用者已輸入其中一格，嘗試用那格立刻刷新其他格
        const u = parseNumber(usdEl.value);
        const t = parseNumber(twdEl.value);
        const j = parseNumber(jpyEl.value);
        if (Number.isFinite(u)) updateFromUSD(u);
        else if (Number.isFinite(t)) updateFromTWD(t);
        else if (Number.isFinite(j)) updateFromJPY(j);

      } catch (err) {
        console.error(err);
        setStatus("匯率載入失敗（可能是網路/跨域限制）", true);
        rateLineEl.textContent = "目前匯率：—";
        timeLineEl.textContent = "提示：你仍可改成「手動固定匯率」版本（我也可以幫你改）。";
      }
    }

    refreshBtn.addEventListener("click", fetchRates);
    clearBtn.addEventListener("click", () => {
      isProgrammaticUpdate = true;
      usdEl.value = "";
      twdEl.value = "";
      jpyEl.value = "";
      isProgrammaticUpdate = false;
    });

    wireInputs();
    fetchRates();
  </script>
</body>
</html>